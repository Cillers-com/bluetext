modules:
  - id: frontend
    module: polytope/node
    args:
      id: frontend
      image: node:22-bullseye-slim
      code: 
        type: host
        path: ./frontend
      cmd: ./bin/run
      env:
        - name: PORT
          value: "#pt-value frontend_port"
        - name: REACT_APP_API_PORT
          value: "#pt-value api_port"
      restart:
        policy: always
      services:
        - id: frontend
          ports: 
            - protocol: http
              port: "#pt-value frontend_port"
              expose-as: "#pt-value frontend_port"
      mounts:
        - path: /root/.cache/
          source: 
            type: volume
            scope: project
            id: dependency-cache
        - path: /root/.npm/
          source: 
            type: volume
            scope: project
            id: npm-cache
        - path: /app/node_modules/
          source: 
            type: volume
            scope: project
            id: npm-modules

  - id: api
    module: polytope/python
    args:
      id: api
      image: python:3.11-slim
      code:
        type: host
        path: ./api
      cmd: ./bin/run
      env:
        - name: PORT
          value: "#pt-value api_port"
        - name: COUCHBASE_HOST
          value: "#pt-value couchbase_host"
        - name: COUCHBASE_USERNAME
          value: "#pt-secret couchbase_username"
        - name: COUCHBASE_PASSWORD
          value: "#pt-secret couchbase_password"
        - name: COUCHBASE_MAIN_BUCKET_NAME
          value: "#pt-value couchbase_bucket_name"
      restart:
        policy: always
      services:
        - id: api
          ports:
            - protocol: http
              port: "#pt-value api_port"
              expose-as: "#pt-value api_port"
      mounts:
        - path: /root/.cache/pip/
          source:
            type: volume
            scope: project
            id: pip-cache

  - id: couchbase
    module: polytope/couchbase
    args:
      image: couchbase:enterprise-7.6.6
      id: couchbase
      restart:
        policy: always
      data-volume:
        type: volume
        scope: project
        id: couchbase-data

  - id: couchbase-init
    module: polytope/python
    args:
      image: python:3.11-slim
      id: init-couchbase
      code:
        type: host
        path: ./util/couchbase-init
      cmd: ./bin/run
      restart:
        policy: on-failure
      env:
        - name: COUCHBASE_HOST
          value: "#pt-value couchbase_host"
        - name: COUCHBASE_USERNAME
          value: "#pt-secret couchbase_username"
        - name: COUCHBASE_PASSWORD
          value: "#pt-secret couchbase_password"
        - name: COUCHBASE_MAIN_BUCKET_NAME
          value: "#pt-value couchbase_bucket_name"
      mounts:
        - path: /root/.cache/
          source:
            type: volume
            scope: project
            id: dependency-cache
        - path: /app/conf/
          source:
            type: host
            path: ./conf/couchbase

templates:
  - id: stack
    info: "Run the React frontend application, Python API server, and Couchbase database"
    run:
      - module: couchbase
      - module: couchbase-init
      - module: frontend
      - module: api
  - id: api-only
    info: "Run only the Python API server"
    run:
      - module: api
